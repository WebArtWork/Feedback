<!DOCTYPE html>
<html ng-app="app">
<head>
	<title>LIST</title>
	<link rel="stylesheet" href="https://raw.githack.com/WebArtWork/wcom/master/wcom-min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/trix/0.9.2/trix.css">
	<link rel="stylesheet" href="/css/templates.css">
	<link rel="stylesheet" href="/gen/public.css">
	<link rel="stylesheet" href="/waw/pages/cms/cms.css">
</head>
<body ng-controller="main">
	<div class="topbar">
		<a class="back" href="/waw/pages">
			<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 21.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
			<svg version="1.1" id="Слой_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25px" height="25px" x="0px" y="0px"
			 viewBox="0 0 20 20" style="enable-background:new 0 0 20 20;" xml:space="preserve">
			<style type="text/css">
			</style>
			<g>
				<path class="st0" d="M17.8,1H2.2C1,1,0.1,2,0.1,3.2v14.2c0,1.2,1,2.2,2.2,2.2h15.5c1.2,0,2.2-1,2.2-2.2V3.2C19.9,2,19,1,17.8,1z
					 M2.2,2.8h15.5c0.2,0,0.4,0.2,0.4,0.4v4H1.8v-4C1.8,3,2,2.8,2.2,2.8z M17.8,17.9H2.2c-0.2,0-0.4-0.2-0.4-0.4V8.9h16.4v8.5
					C18.2,17.7,18,17.9,17.8,17.9z"/>
				<rect x="3.5" y="4.2" class="st0" width="1.6" height="1.6"/>
				<rect x="6.5" y="4.2" class="st0" width="1.6" height="1.6"/>
				<rect x="9.6" y="4.2" class="st0" width="1.6" height="1.6"/>
			</g>
			</svg>
		</a>
		<a class="wawlogo" href="/">
			<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 21.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
			<svg version="1.1" id="Слой_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="20px" x="0px" y="0px"
	 			viewBox="0 0 72.4 19.7" style="enable-background:new 0 0 72.4 19.7;" xml:space="preserve">
			<style type="text/css">
			</style>
			<g>
				<path class="st0" d="M48.8,19.1L48.8,19.1c-0.1,0-0.2,0-0.3,0c0,0-0.1,0-0.1,0C47.5,19,46,18.4,44.8,16l-8-15.7
				c-0.2-0.4-1-0.4-1.2,0l-8,15.7c-1.2,2.4-2.7,2.9-3.6,3.1c0,0-0.1,0-0.1,0c-0.1,0-0.2,0-0.3,0h0c-0.1,0-0.1,0-0.1,0.1v0.4
				c0,0.1,0.1,0.2,0.2,0.2h2h3H33c0.1,0,0.2-0.1,0.2-0.2v-0.3c0-0.1-0.1-0.2-0.3-0.2c-1.7,0-2.9-1.1-2.6-2.3c0.1-0.3,0.2-0.7,0.5-1.1
				c0.7-1,1.8-1.4,2.1-1.6c0.1-0.1,3-1.3,5.8-0.2c1.4,0.5,2.7,1.6,2.9,2.8c0,0.2,0.1,0.6-0.2,1.1c-0.4,0.8-1.5,1.2-1.8,1.3
				c-0.1,0-0.2,0-0.3,0c-0.2,0-0.3,0.1-0.3,0.2v0.3c0,0.1,0.1,0.2,0.2,0.2h4.3h3h2c0.1,0,0.2-0.1,0.2-0.2v-0.4
				C48.9,19.2,48.8,19.1,48.8,19.1z M37.4,12c-0.9,0.5-1.9,0.4-2,0.4c-0.3,0-1.2-0.1-1.9-0.6c-0.6-0.4-0.8-1-0.8-1.1
				c-0.4-1.2,0.6-2.4,1.4-3.4c0.8-1,1.9-2.4,3-2.2c0.8,0.1,1.1,1,1.4,1.7C39,8.2,39.3,10.9,37.4,12z"/>
				<path class="st0" d="M72.2,0.6h-2h-3h-2.6c-1.3-0.1-2.3,0-2.9,0.1c-0.5,0.1-1.3,0.2-2.1,0.6c-0.9,0.4-1.2,0.9-2,1.7
				c-0.9,0.9-1.9,1.8-3.3,2.4c-0.7,0.3-2.3,0.9-4,0.5c-0.9-0.2-1.7-0.7-2.2-1.3l-0.4-0.7c0-0.1-0.1-0.1-0.1-0.2c0,0,0,0,0-0.1
				c-0.1-0.5,0-0.9,0.2-1.2h0c0.4-0.7,1.3-1.2,2.4-1.2c0.2,0,0.3-0.1,0.3-0.2V0.8c0-0.1-0.1-0.2-0.2-0.2h-9.3c-0.1,0-0.2,0.1-0.2,0.2
				v0.4c0,0.1,0.1,0.1,0.1,0.1h0c0.1,0,0.2,0,0.3,0c0,0,0.1,0,0.1,0c0.8,0.1,2.3,0.6,3.6,3l8,15.2c0.2,0.4,1,0.4,1.2,0l2.5-4.7
				l2.5,4.7c0.2,0.4,1,0.4,1.2,0l8-15.2c1.2-2.3,2.7-2.9,3.6-3c0,0,0.1,0,0.1,0c0.1,0,0.2,0,0.3,0h0c0.1,0,0.1,0,0.1-0.1V0.8
				C72.4,0.7,72.3,0.6,72.2,0.6z M55.3,13.1c0,0.1-1,1.2-2.2,1c-0.8-0.1-1.2-0.6-1.4-0.8c-0.7-0.8-0.6-2-0.3-4.2
				c0-0.3,0.1-0.7,0.5-1.2C52,7.7,52.4,7.1,53.1,7c0.6-0.1,1.1,0.3,1.4,0.6c1,0.9,1.1,2.1,1.2,3.1C55.8,11.7,55.8,12.4,55.3,13.1z
				 M63.2,12.3c-0.1,0.8-0.8,1.7-1.9,2c-0.2,0.1-0.6,0.2-1.1,0.1c-1-0.2-1.5-1-1.9-1.7c-0.5-0.8-0.6-1.4-0.7-2.3
				c0-0.2-0.1-0.8,0.1-1.5c0.1-0.3,0.2-0.7,0.5-0.7c0.3,0,0.5,0.2,1,0.6c0.3,0.2,0.2,0.1,1.7,0.9c1,0.5,1.5,0.8,1.6,0.9
				C63.3,11.3,63.2,12.2,63.2,12.3z M64.9,7.3c-0.3,0.6-0.5,1.1-1.1,1.2c-0.1,0-0.4,0.1-1.1,0c-1.4-0.3-2.2-1-2.5-1.3
				c-0.5-0.5-1.1-1-1.2-1.9c-0.1-0.9,0.5-1.5,0.7-1.8c0.2-0.3,0.8-0.9,1.8-1.2c0.4-0.1,1.1-0.3,1.9-0.1c1,0.2,1.4,1,1.6,1.4
				c0.3,0.6,0.3,1.1,0.3,1.6C65.4,5.5,65.3,6.3,64.9,7.3z"/>
				<path class="st0" d="M31.3,0.6h-2h-3H22c-0.1,0-0.2,0.1-0.2,0.2V1c0,0.1,0.1,0.2,0.3,0.2c1.3,0,1.7,0.6,2.2,0.9
				c0.9,0.5,0.4,2.3-0.7,3.5c-0.2,0.2-1.5,1.5-3.5,1.6c-2.2,0-3.7-1.5-3.9-1.6c-0.8-0.8-1.2-1.9-2.5-3c-0.1-0.1-0.3-0.2-0.4-0.3
				C13,1.9,12.3,1.4,11.2,1C9.4,0.4,7.7,0.5,6.9,0.6H5.2h-3h-2C0.1,0.8,0.1,1,0,1.1c0,0.1,0.1,0.1,0.1,0.1h0c0.1,0,0.2,0,0.3,0
				c0,0,0.1,0,0.1,0c0.8,0.1,2.3,0.6,3.6,3l8,15.2c0.2,0.4,1,0.4,1.2,0l2.5-4.7l2.5,4.7c0.2,0.4,1,0.4,1.2,0l8-15.2
				c1.2-2.3,2.7-2.9,3.6-3c0,0,0.1,0,0.1,0c0.1,0,0.2,0,0.3,0h0c0.1,0,0.1,0,0.1-0.1V0.8C31.5,0.7,31.4,0.6,31.3,0.6z M8.9,8
				C7.7,7.8,7.1,7,6.6,6.3C6,5.5,5.2,4.4,5.9,3.3C6.5,2.3,7.9,2,8,2c1.9-0.4,3.8,0.6,4.6,1.6c0.2,0.2,0.6,0.8,0.6,1.5
				c0,1.2-1.2,1.9-1.4,2.1C11.5,7.5,10.3,8.3,8.9,8z M14.5,11.5c-0.6,1-1.4,2.4-2.4,2.4c-0.8,0-1.4-0.8-1.7-1.2
				c-0.6-1.1,0.1-2.1,0.5-2.7c0.2-0.3,0.9-0.9,2.3-2c1-0.8,1.4-1.1,1.7-1c0.4,0.1,0.4,0.7,0.5,1.2C15.4,10,14.6,11.3,14.5,11.5z
				 M19.9,15.1c-0.9,0.2-1.9-0.4-2.1-0.5c-1-0.6-1.1-1.4-1.2-2.4c-0.2-1.1,0.1-1.7,0.2-1.9C17,9.9,17.3,9.4,18,9.2
				c0.6-0.2,1.2,0,1.4,0c1.4,0.4,1.7,1.9,1.8,2.5C21.2,12,21.5,14.7,19.9,15.1z"/>
			</g>
			</svg>
		</a>
	</div>

	<!-- left -->
	<div>
		<div ng-repeat="template in templates" ng-click="page.template=template.name; update(page);">{{template.name}}</div>
		<input type="text" placeholder="url" ng-model="page.url" ng-change="setUrl(page);" ><br>
		<input type="text" placeholder="title" ng-model="page.title" ng-change="update(page);" ><br>
		<textarea placeholder="description" ng-model="page.description" ng-change="update(page);"></textarea><br>
		<textarea placeholder="keywords" ng-keyup="print($event, keyword, this.value);"  ng-model="keyword" ng-change="update(page);"></textarea><br>
		<div>{{page.keywords_view}}</div>
		<label for="pageImage">
			<img ng-src={{page.image}} height="200px">
		</label>
	</div>
	<!-- right -->
	<div ng-repeat="template in templates" ng-include="'/waw/pages/templates/'+template.file" ng-if="page.template==template.name"></div>

	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.7.5/angular.min.js"></script>
	<script src="//raw.githack.com/WebArtWork/wcom/master/wcom-min.js"></script>

	
	<script src="//cdnjs.cloudflare.com/ajax/libs/trix/0.9.2/trix.js"></script>
	<script src="//rawcdn.githack.com/sachinchoolur/angular-trix/3eee4444e2b9b9505ae299d888c7e2363b1c9e3c/dist/angular-trix.min.js"></script>
	
	<script type="text/javascript" src="/waw/pages/cms/cms.js"></script>

	<script>
		var app = angular.module('app', ['wcom', 'angularTrix']);
		app.controller('main', function($scope, $http, mongo, file){
			var _id = window.location.pathname.split('/');
			$http.post('/waw/pages/templates', {
				_id: _id[_id.length-1]
			}).then(function(resp){
				$scope.page=resp.data.page;
				$scope.templates=resp.data.templates;
				if(!$scope.page.template){
					$scope.page.template = $scope.templates[0].name;
				}
			});
			file.add({
				id: 'pageImage',
				width: 1920,
				height: 1080
			}, function(dataUrl) {
				$scope.page.image = dataUrl;
				$http.post('/api/user/file', {
					dataUrl: dataUrl
				}).then(function(resp) {
					$scope.page.image = resp.data;
					$scope.update($scope.page);
				});
			});
			$scope.save_keywords = function(){
				$scope.page.keywords_view="";
				for(var i=0;i<$scope.page.keywords.length;i++){
					if(i!=$scope.page.keywords.length-1) $scope.page.keywords_view+=$scope.page.keywords[i]+', ';
					else $scope.page.keywords_view+=$scope.page.keywords[i];
				}
				$scope.update($scope.page);
			}
			$scope.print = function(event, keyword, el){
				if(event.code=='Enter'){
					if(keyword!='') $scope.page.keywords.push(keyword);	
					$scope.save_keywords();
					$scope.keyword=null;
				}
			}
			$scope.update = function(page){
				mongo.afterWhile(page, function(){
					mongo.updateAll('pages', page);
				});
			}
			$scope.setUrl = function(page){
				if(!page.url) return;
				if(page.url[0]!='/'){
					page.url='/'+page.url;
				}
				mongo.afterWhile(page, function(){
					$http.post('/api/pages/unique/field', page).then(function(resp){		
						page.url=resp.data;
					});
				});
			}
		});
	</script>
</body>
</html>